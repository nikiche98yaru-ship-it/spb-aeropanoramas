<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPB Аэропанорамы — LIVE из Google Sheets</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .toolbar {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.92); backdrop-filter: blur(4px);
      padding: 10px 12px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.12);
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .toolbar label { display: flex; align-items: center; gap: 6px; }
    .toolbar button {
      margin-top: 8px; width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid #ddd;
      background: #fff; cursor: pointer;
    }
    .legend {
      position: absolute; z-index: 1000; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 10px; font: 13px system-ui;
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
    }
    .legend .row { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
    .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <div><strong>Фильтры</strong></div>
    <label><input id="showDone" type="checkbox"> Показывать «сделана»</label>
    <label><input id="showDelivered" type="checkbox" checked> Показывать «сдана/сдано»</label>
    <button id="refreshBtn">Обновить данные</button>
  </div>
  <div class="legend">
    <div><strong>Статус</strong></div>
    <div class="row"><span class="dot" style="background:#2563eb"></span> к съёмке</div>
    <div class="row"><span class="dot" style="background:#f59e0b"></span> сделана</div>
    <div class="row"><span class="dot" style="background:#16a34a"></span> сдана</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // === НАСТРОЙКИ ===
    const SPREADSHEET_ID = "1Cvh4xU407aNrrR14pQ9egbrQbw54M7JNWQGGF1wEiUrU"; // ваш ID таблицы
    const SHEET_NAME = "Объекты"; // имя листа
    // Ссылка CSV (нужно: Файл → Опубликовать в интернете → выбрать лист → CSV)
    // Можно оставить вариант через gviz — тоже работает на публичной таблице:
 const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcttPlsrFo2KYA1P9wpOh7kVy2Zmux-Mu02QDwbQJHLp7BqOk6uYfuys1dQT-EZFgyMV3dYtjKsaWw/pub?gid=1234073055&single=true&output=csv";

    // Названия колонок в таблице
    const COL = {
      num: "№",
      name: "Название ЖК",
      coords: "Координаты ЖК",
      count: "Количество панорам",
      statusPhoto: "Статус фото",
      statusSubmit: "Статус сдачи",
      time: "Время и дата фото",
      link: "Ссылка на фото"
    };

    const map = L.map("map").setView([59.939, 30.314], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
    const layer = L.layerGroup().addTo(map);

    const ui = {
      showDone: document.getElementById("showDone"),
      showDelivered: document.getElementById("showDelivered"),
      refreshBtn: document.getElementById("refreshBtn")
    };
    ui.refreshBtn.addEventListener("click", loadData);
    ui.showDone.addEventListener("change", render);
    ui.showDelivered.addEventListener("change", render);

    let rows = [];     // исходные строки из таблицы
    let markers = [];  // кэш маркеров

    function parseCoords(s) {
      if (!s) return null;
      const m = String(s).match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
      if (!m) return null;
      return [parseFloat(m[1]), parseFloat(m[2])];
    }
    function norm(s) { return String(s||"").trim().toLowerCase(); }
    function statusColor(row) {
      const photo = norm(row[COL.statusPhoto]);
      const submit = norm(row[COL.statusSubmit]);
      if (submit && (submit.includes("сдан") || submit.includes("принят"))) return "#16a34a"; // зелёный
      if (photo && (photo.includes("сделан") || photo.includes("готов"))) return "#f59e0b";  // жёлтый
      return "#2563eb"; // синий — к съёмке
    }
    function shouldShow(row) {
      const photo = norm(row[COL.statusPhoto]);
      const submit = norm(row[COL.statusSubmit]);
      if (!ui.showDone.checked && (photo.includes("сделан") || photo.includes("готов"))) return false;
      if (!ui.showDelivered.checked && (submit.includes("сдан") || submit.includes("принят"))) return false;
      return true;
    }
    function popupHtml(row, lat, lon) {
      const num = row[COL.num] ?? "";
      const name = row[COL.name] ?? "";
      const cnt = row[COL.count] ?? "";
      const photo = row[COL.statusPhoto] ?? "";
      const submit = row[COL.statusSubmit] ?? "";
      const time = row[COL.time] ?? "";
      const link = row[COL.link] ?? "";
      const linkHtml = link ? `<br><a href="${link}" target="_blank" rel="noopener">Ссылка на фото</a>` : "";
      return `<div style="min-width:220px">
        <b>${num ? num + ". " : ""}${name}</b>
        <br>координаты панорамы: ${lat.toFixed(6)}, ${lon.toFixed(6)}
        ${cnt ? `<br>кол-во панорам: ${cnt}` : ""}
        ${photo ? `<br>статус фото: ${photo}` : ""}
        ${time ? `<br>время фото: ${time}` : ""}
        ${submit ? `<br>статус сдачи: ${submit}` : ""}
        ${linkHtml}
      </div>`;
    }

    async function loadData() {
      ui.refreshBtn.disabled = true; ui.refreshBtn.textContent = "Загрузка...";
      try {
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        rows = parsed.data;
        render();
      } catch (e) {
        alert("Не удалось загрузить таблицу. Убедитесь, что лист опубликован (File → Publish to the web → CSV).");
        console.error(e);
      } finally {
        ui.refreshBtn.disabled = false; ui.refreshBtn.textContent = "Обновить данные";
      }
    }

    function render() {
      layer.clearLayers(); markers = [];
      for (const row of rows) {
        const pair = parseCoords(row[COL.coords]);
        if (!pair) continue;
        const [lat, lon] = pair;
        if (!shouldShow(row)) continue;
        const color = statusColor(row);
        const m = L.circleMarker([lat, lon], {
          radius: 7, color, fillColor: color, fillOpacity: 0.85, weight: 1
        }).bindPopup(popupHtml(row, lat, lon));
        m.addTo(layer);
        markers.push(m);
      }
      if (markers.length) {
        const g = L.featureGroup(markers);
        map.fitBounds(g.getBounds().pad(0.2), { animate: false });
      }
    }

    // старт
    loadData();
  </script>
</body>
</html>
